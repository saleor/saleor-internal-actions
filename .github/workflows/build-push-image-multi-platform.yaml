# Builds and push a container image for ARM64 & AMD64 using native runners (no QEMU).
name: Build and Push Container Image

on:
  workflow_call:
    inputs:
      checkout-ref:
        type: string
        default: ""
        description: >-
          The project's branch, tag or SHA to checkout.
          Automatically determine the ref to checkout when omitted or blank,
          typically defaults to the SHA of the event.
      checkout-use-vault:
        type: boolean
        default: false
        description: >-
          Whether to use the vault to fetch repositories. May be needed when passing
          'checkout-submodules' input.
      checkout-submodules:
        type: string
        default: ""
        description: >-
          Whether to checkout submodules, refer to https://github.com/actions/checkout/
      # ======================
      # GitHub Runner Settings
      # ======================
      amd64-runner-image:
        type: string
        default: ubuntu-24.04
        description: >-
          The GitHub runner to use for x64 image building.
          Can be a self-hosted runner, a custom, or GitHub-hosted runner
          (list: https://docs.github.com/en/actions/reference/runners/github-hosted-runners)
      arm64-runner-image:
        type: string
        default: ubuntu-24.04-arm
        description: >-
          The GitHub runner to use for aarch64 image building.
          Can be a self-hosted runner, a custom, or GitHub-hosted runner
          (list: https://docs.github.com/en/actions/reference/runners/github-hosted-runners)
      # ==============
      # Build Settings
      # ==============
      context-path:
        type: string
        default: ./
        description: >-
          The directory that should be used as the context for the `docker build <context>`
          command.
      dockerfile-path:
        type: string
        default: ./Dockerfile
        description: >-
          The path to the Dockerfile to use (must be inside the context), equivalent
          to `docker build -f ./my-path/Dockerfile ./`
      target:
        type: string
        description: >-
          The Dockerfile's build stage to use (same as in `docker build --target <TARGET>`)
      docker-build-summary:
        type: boolean
        default: true
        description: >-
          Whether to generate a build summary (https://docs.docker.com/build/ci/github-actions/build-summary/)
      oci-full-repository:
        type: string
        description: >-
          The repository name, must include the OCI repository hostname, and the repository.

          Example VALID value:
            oci.example.com/acme/my-project

          Invalid:
            - acme/my-project (missing hostname)
            - oci.example.com (missing repository name)

          Examples:
            - AWS ECR: 123456789012.dkr.ecr.us-east-1.amazonaws.com/my-repo/my-image-name
            - GHCR: ghcr.io/my-organization/my-repository-name
            - Docker Hub: docker.io/my-organization/my-repository-name
      tags:
        type: string
        required: true
        description: >-
          List of tags to use to publish the image (newline or comma separated),
          can include or omit the registry's hostname.

          Example without the registry (will use the value from 'oci-full-repository'):
            tags: |
              v1.0.0
              latest

          You can also (optionally) provide the registry and repository name:
            tags: |
              123456789012.dkr.ecr.us-east-1.amazonaws.com/my-repo/my-image-name:v1.0.0
              ghcr.io/my-organization/my-repository-name:v1.0.0
              docker.io/my-organization/my-repository-name:v1.0.0
      build-args:
        type: string
        description: >-
          List of `--build-arg` arguments to pass to the builder.

          Example:
            build-args: |
              MY_ARG1=foo
              MY_ARG2=bar
      labels:
        type: string
        description: List of labels to add to the final image.
      # ================
      # Publish Settings
      # ================
      enable-ghcr:
        type: boolean
        description: >-
          If enabled, it will push to GHCR (GitHub Container Repository).
      enable-aws-ecr:
        type: boolean
        description: >-
          If enabled, it will push to AWS ECR.

          Requires the following settings:
          - aws-ecr-role-to-assume (secret)
          - aws-ecr-registries (secret)
          - aws-ecr-region
      aws-ecr-region:
        type: string
        description: >-
          The AWS region where to push.

    secrets:
      checkout-vault-url:
        description: >-
          The URL to the vault to use to checkout the code; used for downloading
          submodules. Refer to https://github.com/actions/checkout/.
      checkout-vault-jwt:
        description: >-
          The JWT for unlocking the vault in order to checkout the code; used for downloading
          submodules. Refer to https://github.com/actions/checkout/.
      aws-ecr-role-to-assume:
        description: >-
          The IAM role ARN to assume (to push to ECR).
      aws-ecr-registries:
        description: >-
          The list of AWS accounts associated with a AWS ECR registry.

          Example:
            aws-ecr-registries: "123456789012,998877665544"
      oci-full-repository:
        description: >-
          The repository name, must include the OCI repository hostname, and the repository.

          Example VALID value:
            oci.example.com/acme/my-project

          Invalid:
            - acme/my-project (missing hostname)
            - oci.example.com (missing repository name)

          Examples:
            - AWS ECR: 123456789012.dkr.ecr.us-east-1.amazonaws.com/my-repo/my-image-name
            - GHCR: ghcr.io/my-organization/my-repository-name
            - Docker Hub: docker.io/my-organization/my-repository-name
    outputs:
      digest:
        description: The manifest list's digest (e.g., 'sha256:7007b387ccd52bd42a050f2e8020e56e64622c9269bf7bbe257b326fe99daf19')
        value: ${{ jobs.merge-digests.outputs.digest }}

permissions: {}

jobs:
  build:
    name: Build (${{ matrix.runner-image }})
    runs-on: ${{ matrix.runner-image }}

    strategy:
      matrix:
        runner-image:
          - ${{ inputs.amd64-runner-image }}
          - ${{ inputs.arm64-runner-image }}

    permissions:
      id-token: write # Needed for AWS login
      packages: write # Needed for GHCR login
      contents: read

    steps:
      - name: Validate Inputs
        env:
          INPUT_OCI_REPO: ${{ inputs.oci-full-repository }}
          SECRET_OCI_REPO: ${{ secrets.oci-full-repository }}
        run: |
          set -u -o pipefail

          if [[ -z "$INPUT_OCI_REPO" ]] && [[ -z "$SECRET_OCI_REPO" ]]; then
            {
              echo "Missing required input: oci-full-repository must be provided."
              echo "For more information, refer to the documentation under" \
                    ".github/workflows/build-push-image-multi-platform.md"
            } >&2
            exit 1
          fi

      - id: get-token
        name: Get Checkout Token
        if: ${{ inputs.checkout-use-vault }}
        env:
          VAULT_URL: ${{ secrets.checkout-vault-url }}
          VAULT_JWT: ${{ secrets.checkout-vault-jwt }}
        run: |
          token=$(
            curl --request GET --url "$VAULT_URL" --header "Authorization: JWT $VAULT_JWT" | jq -r .token
          )
          echo "::add-mask::$token"
          echo "token=${token}" >> "$GITHUB_OUTPUT"

      # Clone the invoker's repository.
      - name: Checkout Caller's Code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          ref: ${{ inputs.checkout-ref }}
          token: ${{ steps.get-token.outputs.token || github.token }}
          submodules: ${{ inputs.checkout-submodules }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3.12.0
        with:
          install: true

      - if: ${{ inputs.enable-aws-ecr }}
        name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@61815dcd50bd041e203e49132bacad1fd04d2708 # v5.1.1
        with:
          role-to-assume: ${{ secrets.aws-ecr-role-to-assume }}
          aws-region: ${{ inputs.aws-ecr-region }}

      - if: ${{ inputs.enable-aws-ecr }}
        name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@062b18b96a7aff071d4dc91bc00c4c1a7945b076 # v2.0.1
        with:
          registries: ${{ secrets.aws-ecr-registries }}

      - if: ${{ inputs.enable-ghcr }}
        name: Login to GitHub Container Registry
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3.6.0
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and Push
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 # v6.18.0
        id: build
        env:
          DOCKER_BUILD_SUMMARY: ${{ inputs.docker-build-summary }}
        with:
          context: ${{ inputs.context-path }}
          file: ${{ inputs.dockerfile-path }}
          target: ${{ inputs.target }}
          push: true
          cache-from: type=gha
          cache-to: type=gha,mode=max
          # We set `push-by-digest=true` thus we cannot put any tag and thus we use
          # the container repository name instead (ghcr.io/saleor/saleor)
          # (we cannot push both by tags and by digest, only one or the other)
          tags: ${{ inputs.oci-full-repository || secrets.oci-full-repository }}
          labels: ${{ inputs.labels }}
          build-args: ${{ inputs.build-args }}
          outputs: type=image,push-by-digest=true,name-canonical=true,push=true,oci-mediatypes=true

      - name: Export digest
        env:
          BUILD_DIGEST: ${{ steps.build.outputs.digest }}
          RUNNER_TEMP: ${{ runner.temp }}
        run: |
          mkdir -p "$RUNNER_TEMP"/digests
          touch "$RUNNER_TEMP/digests/${BUILD_DIGEST#sha256:}"

      - name: Upload digest
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: digests-${{ matrix.runner-image }}
          path: ${{ runner.temp }}/digests/*
          if-no-files-found: error
          retention-days: 1

  # Merges all built platforms into a single manifest
  merge-digests:
    needs: build

    runs-on: ubuntu-24.04

    permissions:
      id-token: write # Needed for AWS login
      packages: write # Needed for GHCR login
      contents: none

    outputs:
      digest: ${{ steps.push-manifest.outputs.digest }}

    steps:
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@8d2750c68a42422c14e847fe6c8ac0403b4cbd6f # v3.12.0
        with:
          install: true

      - if: ${{ inputs.enable-aws-ecr }}
        name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@61815dcd50bd041e203e49132bacad1fd04d2708 # v5.1.1
        with:
          role-to-assume: ${{ secrets.aws-ecr-role-to-assume }}
          aws-region: ${{ inputs.aws-ecr-region }}

      - if: ${{ inputs.enable-aws-ecr }}
        name: Login to Amazon ECR
        uses: aws-actions/amazon-ecr-login@062b18b96a7aff071d4dc91bc00c4c1a7945b076 # v2.0.1
        with:
          registries: ${{ secrets.aws-ecr-registries }}

      - name: Download digests
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          path: ${{ runner.temp }}/digests
          pattern: digests-*
          merge-multiple: true

      - if: ${{ inputs.enable-ghcr }}
        name: Login to GitHub Container Registry
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3.6.0
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Create manifest list and push
        id: push-manifest
        working-directory: ${{ runner.temp }}/digests
        env:
          REPO: ${{ inputs.oci-full-repository || secrets.oci-full-repository }}
          IMAGE_TAGS: ${{ inputs.tags }}
        run: |
          set -u -o pipefail
          buildx_args=( )

          # Normalize comma-separated tag list into newline separated list
          IMAGE_TAGS=$(echo "$IMAGE_TAGS" | tr ',' $'\n')

          # Build a list of --tag=XXX based on the user-provided tag list
          mapfile -t tag_list <<<"$IMAGE_TAGS"
          for i in "${!tag_list[@]}"; do
            tag="${tag_list[$i]}"

            # If tag doesn't specify the OCI repo, then we add it
            if [[ "$tag" != "$REPO"* ]]; then
              tag="$REPO":"$tag"
              tag_list[i]="$tag"
            fi

            buildx_args+=( --tag="$tag" )
          done

          # Build the list of digests to include inside the final image
          for digest in *; do
            echo "Creating image for digest: ${digest}" >&2
            buildx_args+=( "$REPO@sha256:$digest" )
          done

          docker buildx imagetools create "${buildx_args[@]}"

          # Retrieves the image's digest, useful for importing the image for example.
          # NOTE: running 'inspect' is only necessary until this issue is solved: https://github.com/docker/buildx/issues/2407
          # Example output: sha256:08602e7340970e92bde5e0a2e887c1fde4d9ae753d1e05efb4c8ef3b609f97f1
          echo "Retrieving image digest"
          digest=$(
            docker buildx imagetools inspect "${tag_list[0]}" --format '{{ json .Manifest.Digest }}' \
            | jq -r .
          )
          echo "digest=${digest}" >> "$GITHUB_OUTPUT"
